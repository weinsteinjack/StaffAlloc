# TripSplit: Local-First Prototype Architecture

**Author:** Senior Solutions Architect
**Date:** 2023-10-27
**Version:** 0.1.0
**Status:** DRAFT

This document outlines the technical architecture for a local-first prototype of the TripSplit platform. The primary goal is to rapidly develop and validate core application functionality on a single developer machine, adhering strictly to a local, no-cost technology stack. This approach prioritizes developer velocity and iterative feedback while laying a clear migration path to a scalable, cloud-native production environment.

---

### 1. Executive Summary

This document details the architecture for a fully localized TripSplit prototype. The core objective is to implement the Minimum Viable Product (MVP) features defined in the PRD within a constrained, self-contained environment. This local-first strategy enables rapid iteration on business logic, data models, and AI features without the overhead and cost of cloud infrastructure. All components—from the web server to the database and AI models—are designed to run on a standard developer laptop.

The technology stack is intentionally aligned with the "Day 3 FastAPI + SQLite" pattern, emphasizing modern, high-performance Python tooling. The backend is built with **FastAPI** for its speed and automatic documentation. Data persistence is handled by **SQLite** in WAL (Write-Ahead Logging) mode, managed via **SQLAlchemy ORM** for robust data access and **Alembic** for schema migrations. User-uploaded content, such as receipts, will be stored directly on the **local filesystem**. The prototype will also integrate cutting-edge AI capabilities locally. A local LLM inference server like **Ollama** or **LM Studio** will power a RAG-based chat for querying trip data, and a local vector database such as **ChromaDB** will store embeddings for efficient retrieval.

The primary constraint is the complete avoidance of paid cloud dependencies. This ensures the prototype is portable, easy to set up, and has zero operational cost during the development phase. The architecture is designed with a clear separation of concerns, which will facilitate a future, seamless migration to a production-grade, cloud-native stack (e.g., PostgreSQL, S3, managed AI services) once the core product is validated.

### 2. Logical Architecture

The system is designed with a classic layered architecture to promote separation of concerns, testability, and maintainability.

```mermaid
graph TD
    subgraph "Client Layer"
        A["React SPA"]
        B["Mobile Client - Future"]
        C["CLI / Test Scripts"]
    end

    subgraph "API Layer (FastAPI)"
        D["Auth Router<br>/auth"]
        E["Trips Router<br>/trips"]
        F["Expenses Router<br>/trips/{id}/expenses"]
        G["Settlements Router<br>/trips/{id}/settle"]
        H["Reports Router<br>/trips/{id}/report"]
        I["AI Router<br>/ai/chat"]
    end

    subgraph "Service Layer (Business Logic)"
        J[AuthService]
        K[TripService]
        L[ExpenseService]
        M[BalanceService]
        N[SettlementService]
        O[ReportService]
        P[RAGService]
    end

    subgraph "Data Access Layer (SQLAlchemy)"
        Q["User Repository"]
        R["Trip Repository"]
        S["Expense Repository"]
        T["SQLAlchemy Models"]
        U["Alembic Migrations"]
    end

    subgraph "Background Jobs"
        V["APScheduler<br>e.g., report generation"]
    end

    subgraph "Integration Adapters"
        W["Local File Storage<br>Receipts, Reports"]
        X["Vector Store Adapter<br>ChromaDB / LanceDB"]
        Y["Local LLM Adapter<br>Ollama / LM Studio"]
        Z["SMTP Adapter<br>Local SMTP Debug Server"]
    end

    A & B & C --> D & E & F & G & H & I
    D --> J
    E --> K
    F --> L & M
    G --> N & M
    H --> O
    I --> P

    J --> Q
    K --> R & Q
    L --> S & R
    M --> S
    N --> S
    O --> S
    P --> S

    Q & R & S --> T & U

    O --> V
    P --> V

    L --> W
    O --> W
    P --> X & Y
    J --> Z
```

**Component Breakdown:**

*   **Client Layer**:
    *   **React SPA**: A single-page application (likely built with Vite + React) that serves as the primary user interface for the prototype. It communicates with the API Layer via RESTful HTTP requests.
    *   **Mobile Client (Future)**: The API is designed to be mobile-friendly, but the initial prototype will focus on the web client.
    *   **CLI / Test Scripts**: Command-line tools or scripts for administrative tasks, seeding data, and running automated tests.

*   **API Layer (FastAPI)**:
    *   The entry point for all client requests, responsible for request validation (via Pydantic), routing, and authentication.
    *   Organized into domain-specific routers for clarity:
        *   `auth`: User registration, login (JWT token generation).
        *   `trips`: CRUD operations for trips and participants.
        *   `expenses`: CRUD for expenses within a trip, including receipt uploads.
        *   `settlements`: Calculating balances and generating optimized settlement plans.
        *   `reports`: Generating and downloading trip expense reports.
        *   `ai`: Endpoints for the RAG chat and other AI-driven features.

*   **Service Layer**:
    *   Contains the core business logic, decoupled from the web framework.
    *   Orchestrates calls to the Data Access Layer and other services or adapters.
    *   Examples: `BalanceService` calculates who owes whom; `SettlementService` implements the algorithm to minimize transactions; `RAGService` coordinates the retrieval and generation process for the AI chat.

*   **Data Access Layer (DAL)**:
    *   An abstraction over the database using the Repository pattern.
    *   **SQLAlchemy Models**: Python classes that map to database tables (`User`, `Trip`, `Expense`, etc.).
    *   **Repositories**: Provide a clean, high-level API for database operations (e.g., `user_repo.get_by_email(email)`), hiding the underlying SQLAlchemy session management.

*   **Background Jobs**:
    *   **APScheduler**: A lightweight, in-process scheduler for running asynchronous tasks. For the prototype, this could be used for tasks like generating a large PDF report without blocking the API response.

*   **Integration Adapters**:
    *   Connects the application to external (but local) systems.
    *   **Local File Storage**: A simple adapter to save and retrieve files (receipts, reports) from a designated local directory.
    *   **Vector Store Adapter**: A wrapper around the ChromaDB client library to add, update, and query for expense embeddings.
    *   **Local LLM Adapter**: An adapter to make HTTP requests to the locally running LLM inference server (e.g., Ollama's API).
    *   **SMTP Adapter**: For development, this will connect to a local debug SMTP server (e.g., Python's `smtpd` module) that prints emails to the console instead of sending them.

### 3. Local Deployment Architecture

This architecture is optimized for a single-machine developer experience.

**Process Topology:**

A developer will run three primary long-running processes in separate terminal windows:

1.  **FastAPI Backend Server**:
    *   Command: `uvicorn app.main:app --reload --port 8000`
    *   Serves the REST API on `http://localhost:8000`.
    *   `--reload` enables hot-reloading on code changes.

2.  **React Frontend Dev Server**:
    *   Command: `npm run dev` (or `yarn dev`)
    *   Serves the React SPA on `http://localhost:5173`.
    *   Includes hot-module replacement (HMR) for a fast development loop.
    *   Configured with a proxy to forward API requests from `/api` to `http://localhost:8000` to avoid CORS issues.

3.  **Local AI Server (Ollama)**:
    *   Command: `ollama serve` (or runs as a background service)
    *   Exposes an OpenAI-compatible API, typically on `http://localhost:11434`.
    *   The developer must first pull a model (e.g., `ollama pull llama3:8b`).

**Developer Workflow:**

1.  **Setup**:
    *   Clone the repository.
    *   Install Python dependencies: `pip install -r requirements.txt`.
    *   Install Node.js dependencies: `cd frontend && npm install`.
    *   Install and run Ollama.
    *   Copy `.env.example` to `.env` and configure local settings.
    *   Initialize the database: `alembic upgrade head`.

2.  **Run**:
    *   Start the Ollama server.
    *   Start the FastAPI backend server.
    *   Start the React frontend dev server.
    *   Open `http://localhost:5173` in a browser.

3.  **Test**:
    *   Run backend tests: `pytest`.

**Directory Structure:**

A well-organized directory structure is key for maintainability.

```
tripsplit/
├── .github/workflows/ci.yml       # GitHub Actions for CI
├── .gitignore
├── README.md
├── alembic/                       # Alembic migration scripts
│   ├── versions/
│   └── env.py
├── app/                           # FastAPI application source
│   ├── __init__.py
│   ├── main.py                    # FastAPI app instance and root setup
│   ├── api/                       # API Layer (Routers)
│   │   ├── deps.py                # Dependencies (e.g., get_db_session)
│   │   └── routers/
│   │       ├── auth.py
│   │       ├── trips.py
│   │       └── ai.py
│   ├── core/                      # Core logic and configuration
│   │   ├── config.py              # Pydantic settings management
│   │   └── security.py            # JWT handling, password hashing
│   ├── crud/                      # Data Access Layer (Repositories)
│   │   ├── base.py
│   │   └── crud_expense.py
│   ├── models/                    # SQLAlchemy ORM Models
│   │   ├── trip.py
│   │   └── user.py
│   ├── schemas/                   # Pydantic Schemas (for API validation)
│   │   ├── expense.py
│   │   └── token.py
│   └── services/                  # Service Layer (Business Logic)
│       ├── balance_service.py
│       └── rag_service.py
├── data/                          # Local data storage (gitignored)
│   ├── db/
│   │   └── tripsplit_dev.db       # SQLite database file
│   ├── vector_store/              # ChromaDB data files
│   └── uploads/
│       └── receipts/              # Stored receipt images
├── frontend/                      # React SPA source code
│   ├── src/
│   └── package.json
├── scripts/                       # Helper scripts (e.g., seed_data.py)
├── tests/                         # Pytest tests
│   ├── api/
│   │   └── test_trips.py
│   └── conftest.py                # Pytest fixtures
├── .env                           # Local environment variables (gitignored)
├── alembic.ini                    # Alembic configuration
└── requirements.txt               # Python dependencies
```

### 4. Data & Storage Strategy

All data persistence is handled locally to meet the prototype constraints.

*   **Primary Database**:
    *   **Technology**: SQLite.
    *   **Configuration**: The database file will be located at `data/db/tripsplit_dev.db`.
    *   **WAL Mode**: Enabled (`PRAGMA journal_mode=WAL;`) to allow for better concurrency between the API server and any potential background workers, reducing database locking issues.
    *   **Connection**: SQLAlchemy will be used as the ORM, with a session-per-request pattern managed by FastAPI dependencies.

*   **Schema Management**:
    *   **Technology**: Alembic.
    *   **Workflow**: Developers will use Alembic to auto-generate migration scripts based on changes to SQLAlchemy models. The database schema is version-controlled and can be upgraded (`alembic upgrade head`) or downgraded reliably.

*   **File Storage**:
    *   **Receipts & Reports**: All binary files (receipt images, generated PDF/CSV reports) will be stored directly on the local filesystem under the `data/uploads/` directory.
    *   **Access**: The API will serve these files via a dedicated endpoint that streams the file content, or by providing a relative URL that the client can use. File paths will be stored in the database.

*   **Vector Storage**:
    *   **Technology**: ChromaDB (or LanceDB as an alternative).
    *   **Implementation**: ChromaDB will be run in-process or as a local server. It will store embeddings of expense descriptions and other relevant trip data.
    *   **Location**: The persistence directory for the vector store will be `data/vector_store/`.
    *   **Process**: When an expense is created or updated, a service will generate its embedding (using a local sentence-transformer model) and upsert it into ChromaDB.

*   **Configuration**:
    *   **Technology**: A `.env` file.
    *   **Management**: The `python-dotenv` library will load environment variables, and a Pydantic `Settings` class will validate and provide typed access to configuration throughout the application.
    *   **Example `.env`**:
        ```ini
        # Application Settings
        SECRET_KEY=your_super_secret_key_for_jwt
        ALGORITHM=HS256
        ACCESS_TOKEN_EXPIRE_MINUTES=30

        # Database
        DATABASE_URL="sqlite:///./data/db/tripsplit_dev.db"

        # AI Settings
        EMBEDDING_MODEL_NAME="all-MiniLM-L6-v2"
        LLM_API_BASE_URL="http://localhost:11434/v1"
        LLM_MODEL_NAME="llama3:8b"

        # File Storage
        UPLOADS_DIR="./data/uploads"
        ```

### 5. AI & Automation Features

AI features will be implemented using local, open-source models to avoid cloud dependencies.

*   **Local LLM Integration**:
    *   **Provider**: Ollama will serve as the local inference engine. It provides an OpenAI-compatible API, making it easy to swap with a production service later.
    *   **Model**: A small, capable model like `Llama 3 8B` or `Mistral 7B` will be used for chat and categorization tasks.
    *   **Interaction**: The `RAGService` will use an HTTP client (like `httpx`) to send requests to the Ollama API endpoint (`http://localhost:11434/v1/chat/completions`).

*   **Smart Expense Categorization (US010)**:
    *   **Pipeline**:
        1.  When a user enters an expense description (e.g., "Dinner at Eiffel Tower"), the `ExpenseService` triggers the categorization logic.
        2.  A few-shot prompt is constructed, providing examples of descriptions and their corresponding categories (e.g., 'Food', 'Transport', 'Accommodation', 'Entertainment').
        3.  This prompt is sent to the local LLM via the `LLMAdapter`.
        4.  The LLM returns a JSON object with the suggested category.
        5.  The API returns this suggestion to the frontend, where the user can accept or override it.

*   **RAG Chat Implementation (US005, US014)**:
    *   This feature allows users to ask natural language questions about their trip expenses.
    *   **Indexing Pipeline (Asynchronous)**:
        1.  When an expense is created or updated, a background task is triggered.
        2.  The task formats the expense data into a concise text document (e.g., "On 2023-10-27, Sarah paid $300 for 'Dinner at Eiffel Tower', split equally between Sarah, David, and Emily. Category: Food.").
        3.  A local sentence-transformer model (e.g., `all-MiniLM-L6-v2` loaded via `sentence-transformers`) converts this text into a vector embedding.
        4.  The embedding and its corresponding expense ID are stored in ChromaDB.
    *   **Query Pipeline (Synchronous)**:
        1.  A user asks a question in the chat: "How much did we spend on food?"
        2.  The `RAGService` generates an embedding for the user's query.
        3.  It uses this embedding to perform a similarity search in ChromaDB, retrieving the top N most relevant expense documents.
        4.  These retrieved documents are used as context in a prompt for the local LLM.
        5.  The prompt will be structured like:
            ```
            You are a helpful travel expense assistant for the TripSplit app.
            Based on the following expense data, answer the user's question.
            If the data is insufficient, say you don't have enough information.

            Context:
            - On 2023-10-27, Sarah paid $300 for 'Dinner at Eiffel Tower'... Category: Food.
            - On 2023-10-26, David paid $50 for 'Museum Tickets'... Category: Entertainment.
            - On 2023-10-28, Sarah paid $120 for 'Groceries'... Category: Food.

            User Question: How much did we spend on food?

            Answer:
            ```
        6.  The LLM processes the prompt and generates a natural language answer (e.g., "You spent a total of $420 on food, which includes 'Dinner at Eiffel Tower' and 'Groceries'.").
        7.  The answer is streamed back to the user's chat interface.

*   **Settlement Optimization (US006)**:
    *   This is a deterministic algorithmic feature, not an AI one.
    *   **Algorithm**:
        1.  The `SettlementService` first calculates the net balance for every participant in the trip. Some will have a positive balance (are owed money), and some will have a negative balance (owe money).
        2.  It creates two lists: `debtors` and `creditors`.
        3.  A greedy algorithm is applied:
            *   While there are debtors and creditors, take the largest debtor and largest creditor.
            *   Calculate the transaction amount as `min(abs(debtor_balance), creditor_balance)`.
            *   Record a transaction: "Debtor pays Creditor this amount."
            *   Update the balances of both.
            *   If a participant's balance becomes zero, remove them from their list.
        4.  This process continues until all balances are zero. The resulting list of transactions is the optimized settlement plan.

### 6. Security & Privacy

Even for a local prototype, foundational security practices are essential.

*   **Authentication**:
    *   **Mechanism**: JSON Web Tokens (JWT) will be used for securing API endpoints.
    *   **Flow**:
        1.  A user logs in with email/password.
        2.  The `/auth/token` endpoint validates credentials and, if successful, returns an `access_token`.
        3.  The client stores this token and includes it in the `Authorization: Bearer <token>` header for all subsequent requests to protected endpoints.
    *   **Password Security**: Passwords will be hashed using `passlib` (with bcrypt as the default scheme) and never stored in plaintext.

*   **Authorization**:
    *   API endpoints will use FastAPI dependencies to ensure that a user can only access data related to trips they are a participant in. For example, a request to `GET /trips/{trip_id}/expenses` will first verify that the authenticated user (from the JWT) is a member of `trip_id`.

*   **Local Secrets Management**:
    *   All sensitive configuration values (e.g., `SECRET_KEY` for JWT signing) will be stored in the `.env` file.
    *   This file is explicitly listed in `.gitignore` to prevent accidental commitment to version control.

*   **File Permissions**:
    *   The application will run under the developer's user account. Standard OS-level file permissions on the `data/` directory will apply. No special permissions are required. For a production deployment, this would require more stringent controls.

*   **Data Encryption**:
    *   **In Transit**: Not applicable for a purely local setup, as all communication is via `localhost`. In production, this would be handled by TLS/SSL termination at the load balancer or reverse proxy.
    *   **At Rest**: The SQLite database file and uploaded files will not be encrypted at rest for this prototype. This is a known simplification; production systems would require encryption at rest for the database and object storage.

### 7. Testing & Quality

A robust testing strategy ensures the prototype is reliable and easy to refactor.

*   **Unit & Integration Testing**:
    *   **Framework**: `pytest` will be used for all backend testing.
    *   **Database**: For fast, isolated unit tests, an in-memory SQLite database will be used. For integration tests that need to verify filesystem interactions or more complex database queries, a temporary file-based SQLite database will be created and torn down for each test session.
    *   **Test Client**: FastAPI's `TestClient` will be used to make requests to the application in tests without needing a running server.
    *   **Fixtures**: `pytest` fixtures will be used extensively to provide dependencies like database sessions, test clients, and sample data (e.g., a pre-created user and trip).

*   **Code Quality & Linting**:
    *   **Linter/Formatter**: `ruff` will be used for extremely fast linting and auto-formatting, ensuring a consistent code style.
    *   **Type Checking**: `mypy` will be run in the CI pipeline to enforce static type checking, catching a large class of potential bugs before runtime.

*   **Continuous Integration (CI)**:
    *   **Platform**: GitHub Actions.
    *   **Workflow**: A `ci.yml` file will define a workflow that triggers on every push to `main` or pull request.
    *   **Steps**:
        1.  Check out the code.
        2.  Set up a specific Python version.
        3.  Install dependencies from `requirements.txt`.
        4.  Run the linter (`ruff check .`).
        5.  Run the type checker (`mypy app`).
        6.  Run the test suite (`pytest`).

### 8. Observability

While extensive observability is overkill for a local prototype, basic tools are crucial for debugging.

*   **Logging**:
    *   **Library**: `structlog` will be used for structured, context-aware logging.
    *   **Format**: Logs will be output as JSON in development, making them easy to parse and filter.
    *   **Context**: A middleware will add request-specific context (like a `request_id`) to all log messages generated during that request's lifecycle.

*   **Health Checks**:
    *   A simple, unauthenticated endpoint like `GET /health` will be created.
    *   It will return a `200 OK` status with a simple JSON body `{"status": "ok"}`. This is useful for verifying that the API server is running.

*   **Optional Metrics & Tracing**:
    *   These are out of scope for the initial prototype.
    *   **Migration Path**: The FastAPI ecosystem has excellent support for integrating tools like Prometheus (for metrics) and OpenTelemetry (for tracing) when moving to a production environment.

### 9. Risks & Migration Path

This local-first architecture is a means to an end. It is critical to understand its limitations and the path to a production-ready system.

| Risk                               | Mitigation (Prototype)                                                                                             | Migration Path (Production)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ...|
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Scalability & Performance**      | SQLite is not designed for high concurrency. Performance will degrade under any significant load. WAL mode helps but is not a solution. | **Database**: Migrate from SQLite to a managed PostgreSQL instance (e.g., AWS RDS). This requires minimal code changes due to SQLAlchemy's dialect system. **API**: Containerize the FastAPI application using Docker and deploy it to a scalable platform like AWS ECS or Kubernetes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     - |
| **Data Durability & Availability** | The entire application state (DB, files) resides on a single developer laptop. This is a single point of failure with high risk of data loss. | **Database**: Use a managed database with automated backups, point-in-time recovery, and high-availability replicas. **File Storage**: Migrate from the local filesystem to a cloud object store like Amazon S3 for durable, scalable, and highly available file storage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - |
| **AI Feature Reliability**         | Local models (e.g., Llama 3 8B) are less powerful than large cloud-based models (e.g., GPT-4). Results for categorization and RAG may be less accurate. | **AI Services**: Switch from local Ollama to a managed AI service like OpenAI API, Amazon Bedrock, or Google Vertex AI. This provides access to state-of-the-art models. **Vector DB**: Migrate from local ChromaDB to a managed vector database like Pinecone or Weaviate Cloud for scalability and performance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - |
| **Background Jobs & Async Tasks**  | Using an in-process scheduler like APScheduler is simple but not robust. If the main API process dies, the scheduler dies with it. | **Task Queue**: Implement a distributed task queue like Celery with RabbitMQ or Redis as the message broker. This decouples task execution from the API lifecycle, improving reliability and scalability. The RAG indexing pipeline would be a prime candidate for this.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - |